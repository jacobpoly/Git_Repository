<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="event_ns">

	<select id="sel_mem2client" parameterType="str" resultType="studentVO">
	
	SELECT	CASE WHEN ENTER_CNT > 0 THEN 'Y' ELSE 'N' END ENTER_YN				
			, ENTER_CNT													
			, CASE WHEN A.STUDENT_STT_BRN = '03' THEN 'Y' ELSE 'N' END NOW_YN	
			, A.MEMBER_CODE													
			, A.CLIENT_CODE													
			, A.CLIENT_MEM_CODE													
		FROM	(
			SELECT	COUNT(*) ENTER_CNT, A.CLIENT_MEM_CODE, B.MEMBER_CODE, B.CLIENT_CODE, STUDENT_STT_BRN
			FROM	DBO.TB_MKB_EVENT_ENTER A
			INNER	JOIN G2_KCMS.dbo.VW_STA_STUDENT B ON A.CLIENT_MEM_CODE = B.CLIENT_MEM_CODE
			WHERE	A.EVENT_NO = 1
			AND		B.MEMBER_CODE = #{member_code}
			GROUP	BY A.CLIENT_MEM_CODE, B.MEMBER_CODE, B.CLIENT_CODE, STUDENT_STT_BRN
		)A
	</select>
	
	 
	 <select id="sel_progressData" parameterType="str" resultType="progressDataVO">
	 SELECT	
	 		A.in_college											
			, A.enter_cnt											
			, DATEDIFF(S, B.EVENT_START_DATE, GETDATE()) as cs_time		
			, DATEDIFF(S, EVENT_START_DATE, B.EVENT_END_DATE)  as es_time	
		FROM (
				SELECT	SUM(A.재학생) as in_college, SUM(A.응모여부) as enter_cnt
				--, (SELECT EVENT_NO, EVENT_NAME FROM G2_KEMS.DBO.TB_MKB_EVENT WHERE EVENT_NO = 1)
		FROM (
				SELECT	1 [재학생], CASE WHEN C.CLIENT_MEM_CODE IS NULL THEN 0 ELSE 1 END [응모여부]
				FROM	G2_KEMS.DBO.TB_CLB_MEMBER A
				INNER	JOIN G2_KEMS.DBO.TB_CLB_STUDENT B ON A.CLIENT_MEM_CODE = B.CLIENT_MEM_CODE
				LEFT	OUTER JOIN G2_KEMS.DBO.TB_MKB_EVENT_ENTER C ON B.CLIENT_MEM_CODE = C.CLIENT_MEM_CODE
				WHERE	A.CLIENT_CODE =#{client_code}
				AND		A.CURRENT_APP_YN = 'Y'
				AND		B.STUDENT_STT_CODE IN ('31','32','33','34')
		) A
	)A
	INNER	JOIN (
		SELECT EVENT_START_DATE, EVENT_END_DATE, CONVERT(NCHAR(8), GETDATE(), 112) CURR_DATE
		FROM DBO.TB_MKB_EVENT 
		WHERE EVENT_NO = 1
	)B ON 1=1
	 
	 </select>

	<select id="sel_product_list" parameterType="str" resultType="productVO">
		SELECT	 C.PRODUCT_NO					-- INT
			, D.PRODUCT_NAME				-- NVARCHAR(30)
			, C.LEFT_PRODUCT_CNT			-- INT
		FROM	DBO.TB_MKB_EVENT A
		INNER	JOIN DBO.TB_MKB_EVENT_CLIENT B ON A.EVENT_NO = B.EVENT_NO
		INNER	JOIN DBO.TB_MKB_EVENT_PRODUCT_CONFIG_CLIENT C ON B.EVENT_NO = C.EVENT_NO AND B.CLIENT_CODE = C.CLIENT_CODE
		INNER	JOIN DBO.TB_MKA_PRODUCT D ON C.PRODUCT_NO = D.PRODUCT_NO
		WHERE	1=1
		AND		A.EVENT_NO = 1
		AND		B.CLIENT_CODE = #{client_code}
	</select>

	<select id="sel_product" parameterType="h_map" resultType="productVO">
		SELECT	C.PRODUCT_NO			-- INT
			, D.PRODUCT_NAME		-- NVARCHAR(30)
			, C.LEFT_PRODUCT_CNT	-- INT
		FROM	DBO.TB_MKB_EVENT A
		INNER	JOIN DBO.TB_MKB_EVENT_CLIENT B ON A.EVENT_NO = B.EVENT_NO
		INNER	JOIN DBO.TB_MKB_EVENT_PRODUCT_CONFIG_CLIENT C ON B.EVENT_NO = C.EVENT_NO AND B.CLIENT_CODE = C.CLIENT_CODE
		INNER	JOIN DBO.TB_MKA_PRODUCT D ON C.PRODUCT_NO = D.PRODUCT_NO
		WHERE	1=1
		AND		A.EVENT_NO = 1
		AND		B.CLIENT_CODE =#{client_code}
		AND		D.PRODUCT_NO =#{product_no}
	</select>
	
	<select id="sel_excel_list" resultType="studentVO">
	SELECT	A.MEMBER_CODE [MEMBER_CODE]
		, A.MEMBER_NAME [MEMBER_NAME]
		, A.STUDENT_STT [STUDENT_STT]
		, A.CLIENT_NAME [CLIENT_NAME]
		, A.CLASS_NAME [CLASS_NAME]
		, A.COURSE_NAME [COURSE_NAME]
		, A.PRODUCT_NAME [PRODUCT_NAME]
		, A.LOG_DTTM [LOG_DTTM]
		, A.FIRST_REG_DTTM [FIRST_REG_DTTM]
		, A.EVENT_MESSAGE [EVENT_MESSAGE]
		, A.EVENT_ENTER_YN [EVENT_ENTER_YN]
		, A.STUDENT_ADDR [STUDENT_ADDR]
		, A.MOTHER_HANDPHONE_NO [MOTHER_HANDPHONE_NO]
	FROM (
			SELECT	C.MEMBER_CODE
					, G2_KEMS.dbo.FN_SYD_GET_LOCALE_VALUE(C.N_LOCALE_CODE,'KR') [MEMBER_NAME]
					, CASE	WHEN C.STUDENT_STT_BRN = '02' THEN '대기'
							WHEN C.STUDENT_STT_BRN = '03' THEN '재학'	
							WHEN C.STUDENT_STT_BRN = '04' THEN '휴학'	
						END STUDENT_STT
					, G2_KEMS.DBO.FN_CLA_GET_CLIENT_NAME(C.CLIENT_CODE, 'KR', 'D') [CLIENT_NAME]
					, F.CLASS_NAME
					, G2_KEMS.dbo.FN_SYD_GET_LOCALE_VALUE(E.N_LOCALE_CODE, 'KR') [COURSE_NAME]
					, H.PRODUCT_NAME
					, LO.LOG_DTTM
					, G.FIRST_REG_DTTM
					, G.EVENT_MESSAGE
					, CASE	WHEN G.FIRST_REG_DTTM IS NULL THEN 'N' ELSE 'Y' END EVENT_ENTER_YN
					, C.ADDRESS +' '+ C.DETAIL_ADR STUDENT_ADDR
					, C.MOTHER_HANDPHONE_NO MOTHER_HANDPHONE_NO
					, C.CLIENT_MEM_CODE
			FROM	G2_KCMS.dbo.TB_CLB_CLASS_ASSIGN A WITH (NOLOCK)
			INNER	JOIN (
							SELECT	ROW_NUMBER() OVER (PARTITION BY A.CLIENT_MEM_CODE ORDER BY B.MANAGE_GBN, TL_STT) NO, A.CLASS_ASS_CODE 
							FROM	G2_KCMS.dbo.TB_CLB_CLASS_ASSIGN A WITH (NOLOCK)
							INNER	JOIN G2_KCMS.dbo.TB_CLB_CLASS B WITH (NOLOCK) ON A.CLIENT_CODE = B.CLIENT_CODE AND A.CLASS_CODE = B.CLASS_CODE
							WHERE	A.TL_STT IN ('01','02')
							AND		B.MANAGE_STT = '01'	-- 개강 클래스 
							AND		B.LEARNING_YEAR_CODE = 2013
							AND		B.SEMESTER_GBN = '02'
							--AND CONVERT(NCHAR(8), @SEARCH_DATE, 112) BETWEEN A.STATUS_SRT_DATE AND A.STATUS_END_DATE
							GROUP	BY A.CLIENT_MEM_CODE, A.CLASS_ASS_CODE,  B.MANAGE_GBN, A.TL_STT
						) B ON A.CLASS_ASS_CODE = B.CLASS_ASS_CODE
			INNER	JOIN G2_KCMS.dbo.VW_STA_STUDENT C WITH (NOLOCK) ON A.CLIENT_MEM_CODE = C.CLIENT_MEM_CODE
			LEFT	OUTER JOIN G2_LCMS.dbo.TB_MTA_COURSE D WITH (NOLOCK) ON C.FINAL_CRS_CODE = D.COURSE_CODE
			LEFT	OUTER JOIN G2_LCMS.dbo.TB_MTA_COURSE E WITH (NOLOCK) ON D.PARENT_CRS_CODE = E.COURSE_CODE	
			INNER	JOIN G2_KCMS.dbo.TB_CLB_CLASS F WITH (NOLOCK) ON A.CLIENT_CODE = F.CLIENT_CODE AND A.CLASS_CODE = F.CLASS_CODE
			LEFT	OUTER JOIN DBO.TB_MKB_EVENT_ENTER G ON C.CLIENT_MEM_CODE = G.CLIENT_MEM_CODE AND G.EVENT_NO = 1
			LEFT	OUTER JOIN DBO.TB_MKA_PRODUCT H ON G.PRODUCT_NO = H.PRODUCT_NO
			INNER	JOIN DBO.TB_MKB_EVENT_CLIENT I ON A.CLIENT_CODE = I.CLIENT_CODE
			FULL	OUTER JOIN G2_LOGDB.DBO.TB_CON_LOGIO_HOMEPAGE LO ON C.CLIENT_MEM_CODE = LO.CLIENT_MEM_CODE
			WHERE	1=1
			AND		B.NO = 1
			AND		C.STUDENT_STT_BRN IN ('02','03','04')	-- 대기/재학/휴학
			)A
			ORDER	BY A.CLIENT_NAME, A.MEMBER_CODE
	
	</select>
	
	<insert id="ins_eventMsg" parameterType="eventVO">
	
		INSERT	INTO DBO.TB_MKB_EVENT_ENTER (
										EVENT_NO				-- INT
										, EVENT_SCHEDULE_SEQ	-- INT
										, CLIENT_MEM_CODE		-- INT
										, PRODUCT_NO			-- INT
										, WIN_YN				-- NCHAR(1)
										, EVENT_MESSAGE			-- NVARCHAR(MAX)
										, STUDENT_STT_CODE		-- NCHAR(2)
										, FIRST_REG_DTTM		-- DATETIME
										, FIRST_REG_MEM_CODE	-- NVARCHAR(10)
										, FIRST_REG_IP			-- NVARCHAR(23)
								)	
		VALUES	(1, 1, #{client_mem_code}, #{product_no}, #{win_yn}, #{event_message}, #{student_stt_code}, GETDATE(), #{first_reg_mem_code}, #{first_reg_ip})
	</insert>
	
	<update id="ups_product_sub" parameterType="eventVO">
		UPDATE	DBO.TB_MKB_EVENT_PRODUCT_CONFIG_CLIENT
				SET		LEFT_PRODUCT_CNT = LEFT_PRODUCT_CNT - 1			-- INT
				, LAST_UPD_DTTM = GETDATE()						-- DATETIME
				, LAST_UPD_MEM_CODE = #{first_reg_mem_code}		-- NVARCHAR(10)
				, LAST_UPD_IP = #{first_reg_ip}					-- NVARCHAR(23)
		WHERE	EVENT_NO = 1									
		AND		PRODUCT_NO = #{product_no}									-- INT
		AND		CLIENT_CODE = #{client_code}							-- NVARCHAR(10)
		AN	D		LEFT_PRODUCT_CNT > 0
		AND		EVENT_SCHEDULE_SEQ = 1
	</update>
	
	<update id="ups_targerCnt_sub" parameterType="eventVO">
	
	UPDATE	DBO.TB_MKB_EVENT_CLIENT				
		SET		LEFT_TARGET_CNT = LEFT_TARGET_CNT - 1
		, LAST_UPD_DTTM = GETDATE()
		, LAST_UPD_MEM_CODE =#{first_reg_mem_code}
		, LAST_UPD_IP =#{first_reg_ip}
		WHERE	EVENT_NO = 1
		AND		CLIENT_CODE =  #{client_code}		-- NVARCHAR(10)
		AND		LEFT_TARGET_CNT > 0
	</update>

</mapper>